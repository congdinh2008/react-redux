<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React-Redux</title>
</head>

<body>

    <main>
        <section class="todo">
            <h2>Todo</h2>
            <label for="todo">Name</label>
            <input type="text" name="todo" id="todo" placeholder="Todo Name">
            <input type="submit" value="Submit" id="todo-submit">
            <ol class="list-item" id="todo-list">
            </ol>
        </section>

        <section class="goal">
            <h2>Goal</h2>
            <label for="goal">Name</label>
            <input type="text" name="goal" id="goal" placeholder="Goal Name">
            <input type="submit" value="Submit" id="goal-submit">
            <ol class="list-item" id="goal-list">
            </ol>
        </section>
    </main>

    <script type="text/javascript">

        const generateId = () => {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        document.getElementById('todo-submit').addEventListener('click', () => {
            createTodo();
        })

        document.getElementById('goal-submit').addEventListener('click', () => {
            createGoal();
        })

        const createTodo = () => {
            const input = document.getElementById('todo');
            const todoName = input.value;
            input.value = ''

            store.dispatch(addTodoAction({
                id: generateId(),
                name: todoName,
                completed: false
            }))
        }


        const createGoal = () => {
            const input = document.getElementById('goal');
            const goalName = input.value;
            input.value = ''

            store.dispatch(addGoalAction({
                id: generateId(),
                name: goalName
            }))
        }

        const createRemoveButton = (onClick) => {
            const remove = document.createElement('button');
            remove.innerHTML = 'x';
            remove.addEventListener('click', onClick);
            return remove;
        }

        const addTodoToDOM = (todo) => {
            const node = document.createElement('li');
            node.innerHTML = todo.name

            node.style.textDecoration = todo.completed ? 'line-through' : 'none'

            node.addEventListener('click', () => {
                store.dispatch(toggleTodoAction(todo.id))
            })

            const removeButton = createRemoveButton(() => {
                store.dispatch(removeTodoAction(todo.id))
            })

            node.appendChild(removeButton);

            document.getElementById('todo-list').appendChild(node);
        }

        const addGoalToDOM = (goal) => {
            const node = document.createElement('li');
            node.innerHTML = goal.name

            const removeButton = createRemoveButton(() => {
                store.dispatch(removeGoalAction(goal.id))
            })

            node.appendChild(removeButton);

            document.getElementById('goal-list').appendChild(node);
        }

        const ADD_TODO = 'ADD_TODO';
        const UPDATE_TODO = 'UPDATE_TODO';
        const TOGGLE_TODO = 'TOGGLE_TODO';
        const REMOVE_TODO = 'REMOVE_TODO';
        const ADD_GOAL = 'ADD_GOAL';
        const UPDATE_GOAL = 'UPDATE_GOAL';
        const REMOVE_GOAL = 'REMOVE_GOAL';
        const goals = (state = [], action) => {
            switch (action.type) {
                case ADD_GOAL:
                    return state.concat([action.goal])
                    break;
                case UPDATE_GOAL:
                    return state.map(goal => goal.id !== action.id ? goal : Object.assign({}, goal, action.goal))
                    break;
                case REMOVE_GOAL:
                    return state.filter(goal => goal.id !== action.id)
                    break;

                default:
                    return state
                    break;
            }
        }

        const todos = (state = [], action) => {
            switch (action.type) {
                case ADD_TODO:
                    return state.concat([action.todo])
                    break;
                case UPDATE_TODO:
                    return state.map(todo => todo.id !== action.id ? todo : Object.assign({}, todo, action.todo))
                    break;
                case TOGGLE_TODO:
                    return state.map(todo => todo.id !== action.id ? todo : Object.assign({}, todo, { completed: !todo.completed }))
                    break;
                case REMOVE_TODO:
                    return state.filter(todo => todo.id !== action.id)
                    break;

                default:
                    return state
                    break;
            }
        }

        const addTodoAction = (todo) => {
            return {
                type: ADD_TODO,
                todo: todo
            }
        }

        const updateTodoAction = (todo) => {
            return {
                type: UPDATE_TODO,
                todo: todo
            }
        }

        const toggleTodoAction = (id) => {
            return {
                type: TOGGLE_TODO,
                id: id
            }
        }

        const removeTodoAction = (id) => {
            return {
                type: REMOVE_TODO,
                id: id
            }
        }

        const addGoalAction = (goal) => {
            return {
                type: ADD_GOAL,
                goal: goal
            }
        }

        const updateGoalAction = (goal) => {
            return {
                type: UPDATE_GOAL,
                goal: goal
            }
        }

        const removeGoalAction = (id) => {
            return {
                type: REMOVE_GOAL,
                id: id
            }
        }

        const app = (state = {}, action) => {
            return {
                todos: todos(state.todos, action),
                goals: goals(state.goals, action),

            }
        }

        const createStore = (app) => {
            let state = [];
            let listeners = [];
            const getState = () => state;

            const subscribe = (listener) => {
                listeners.push(listener)

                return () => {
                    listeners = listeners.filter(x => x.listener != listener)
                }
            }

            const dispatch = (action) => {
                state = app(state, action);
                listeners.forEach(listener => listener())
            }

            return {
                getState,
                subscribe,
                dispatch
            }
        }

        const store = createStore(app);

        store.subscribe(() => {
            const { todos, goals } = store.getState();
            console.log(store.getState())

            document.getElementById('todo-list').innerHTML = ''
            document.getElementById('goal-list').innerHTML = ''

            todos.forEach(addTodoToDOM)
            goals.forEach(addGoalToDOM)
        })
    </script>
</body>

</html>